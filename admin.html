<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم الإدارة | العدسة الكونية</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/JTrI2AU.png">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root {
            --primary: #D4AF37;
            --primary-light: #F4E4B1;
            --primary-dark: #B8941F;
            --gradient: linear-gradient(135deg, #D4AF37, #F4E4B1, #B8941F);
            --gradient-light: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(244, 228, 177, 0.1));
            --gradient-hover: linear-gradient(135deg, #F4E4B1, #D4AF37, #B8941F);
            --background: #000000;
            --surface: #1A1A1A;
            --surface-light: #2A2A2A;
            --text-primary: #FFFFFF;
            --text-secondary: #CCCCCC;
            --text-muted: #999999;
            --border: rgba(212, 175, 55, 0.3);
            --shadow: 0 4px 20px rgba(212, 175, 55, 0.1);
            --shadow-hover: 0 8px 30px rgba(212, 175, 55, 0.2);
            --danger: #dc3545;
            --success: #28a745;
            --warning: #ffc107;
            --info: #17a2b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            direction: rtl;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 30px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo img {
            width: 50px;
            height: 50px;
        }

        .logo h1 {
            font-size: 24px;
            color: var(--primary);
            margin: 0;
        }

        .user-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            background: var(--gradient);
            color: #000000;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-family: 'Tajawal', sans-serif;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: var(--gradient-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: var(--warning);
            color: black;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .login-screen, .admin-panel {
            background-color: var(--surface);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
            margin: 50px auto;
            max-width: 500px;
        }

        .admin-panel {
            max-width: 100%;
            display: none;
        }

        h2 {
            color: var(--primary);
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            background-color: var(--surface-light);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Tajawal', sans-serif;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
        
        /* تحسين عرض التبويبات على الأجهزة المحمولة */
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
                align-items: center;
            }
            
            .tab {
                width: 100%;
                text-align: center;
                padding: 15px;
                margin-bottom: 5px;
            }
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background-color: var(--surface-light);
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid var(--border);
        }

        th {
            background-color: var(--surface);
            color: var(--primary);
            font-weight: 700;
        }

        tr:last-child td {
            border-bottom: none;
        }
        
        /* تحسين عرض الجدول على الأجهزة المحمولة */
        @media (max-width: 768px) {
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            th, td {
                padding: 10px;
            }
            
            .product-image {
                max-width: 50px;
                max-height: 50px;
            }
        }

        .product-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
        }

        .actions {
            display: flex;
            gap: 10px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-col {
            flex: 1;
        }
        
        /* تحسين عرض النموذج على الأجهزة المحمولة */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .form-col {
                width: 100%;
                margin-bottom: 15px;
            }
            
            .admin-panel {
                padding: 15px;
            }
            
            .modal-content {
                width: 95%;
                padding: 15px;
            }
        }

        .alert {
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background-color: rgba(40, 167, 69, 0.2);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .alert-danger {
            background-color: rgba(220, 53, 69, 0.2);
            border: 1px solid var(--danger);
            color: var(--danger);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
            padding: 50px 0;
        }

        .modal-content {
            background-color: var(--surface);
            border-radius: 12px;
            max-width: 800px;
            margin: 0 auto;
            padding: 30px;
            position: relative;
        }
        
        /* تحسين عرض النوافذ المنبثقة على الأجهزة المحمولة */
        @media (max-width: 768px) {
            .modal-content {
                width: 90%;
                margin: 10% auto;
                padding: 20px;
            }
            
            .modal {
                padding: 20px 0;
            }
        }

        .close-modal {
            position: absolute;
            top: 15px;
            left: 15px;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-modal:hover {
            color: var(--primary);
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 50px;
        }

        .spinner {
            border: 4px solid rgba(212, 175, 55, 0.3);
            border-radius: 50%;
            border-top: 4px solid var(--primary);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .features-container {
            margin-top: 15px;
            width: 100%;
        }

        .feature-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            background-color: var(--surface-light);
            padding: 10px;
            border-radius: 8px;
            width: 100%;
        }

        .feature-item input {
            flex: 1;
            margin-left: 10px;
        }
        
        .feature-input, .image-input {
            flex: 1;
        }

        .add-feature-btn, .remove-feature-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 16px;
            padding: 5px;
            transition: color 0.3s ease;
        }

        .add-feature-btn:hover {
            color: var(--success);
        }

        .remove-feature-btn:hover {
            color: var(--danger);
        }

        .images-container {
            margin-top: 15px;
        }

        .image-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            background-color: var(--surface-light);
            padding: 10px;
            border-radius: 8px;
        }

        .image-item input {
            flex: 1;
            margin-left: 10px;
        }
        
        /* تحسينات إضافية للتجاوب مع الأجهزة المحمولة */
        @media (max-width: 768px) {
            .feature-item, .image-item {
                flex-wrap: nowrap;
                width: 100%;
            }
            
            .feature-input, .image-input {
                flex: 1;
                width: auto;
            }
            
            .add-feature-btn, .remove-feature-btn {
                padding: 8px;
                margin-top: 0;
            }
            
            .features-container, .images-container {
                width: 100%;
                margin-top: 10px;
            }
            
            .spinner {
                width: 30px;
                height: 30px;
            }
        }

        /* تحسين عرض حقول الميزات والصور */
        .features-container, .images-container {
            width: 100%;
            margin-bottom: 15px;
        }

        .feature-item, .image-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            width: 100%;
        }

        .feature-input, .image-input {
            flex: 1;
            width: 100%;
        }

        /* إصلاح مشكلة عدم ظهور حقول نموذج إضافة المنتج */
        #addProductTab {
            display: none;
        }

        #addProductTab.active {
            display: block;
        }

        /* تحسين عرض الأزرار في نموذج إضافة المنتج */
        #addProductForm .btn {
            display: block;
            width: 100%;
            margin-top: 20px;
        }

        /* تحسين عرض أزرار إضافة الميزات والصور */
        .add-feature-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            margin-top: 10px;
            padding: 8px 15px;
            background-color: var(--surface-light);
            color: var(--text-secondary);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .add-feature-btn:hover {
            background-color: var(--surface);
            color: var(--primary);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <img src="https://i.imgur.com/JTrI2AU.png" alt="العدسة الكونية">
                <h1>لوحة تحكم الإدارة | العدسة الكونية</h1>
            </div>
            <div class="user-actions">
                <button id="logoutBtn" class="btn btn-danger" style="display: none;">تسجيل الخروج</button>
            </div>
        </header>

        <!-- شاشة تسجيل الدخول -->
        <div id="loginScreen" class="login-screen">
            <h2>تسجيل الدخول</h2>
            <div id="loginAlert" class="alert alert-danger" style="display: none;"></div>
            <div class="form-group">
                <label for="email">البريد الإلكتروني</label>
                <input type="email" id="email" placeholder="أدخل البريد الإلكتروني">
            </div>
            <div class="form-group">
                <label for="password">كلمة المرور</label>
                <input type="password" id="password" placeholder="أدخل كلمة المرور">
            </div>
            <button id="loginBtn" class="btn login-btn">دخول</button>
        </div>

        <!-- لوحة التحكم -->
        <div id="adminPanel" class="admin-panel">
            <div class="tabs">
                <div class="tab active" data-tab="products">المنتجات</div>
                <div class="tab" data-tab="add-product">إضافة منتج جديد</div>
            </div>

            <!-- قسم المنتجات -->
            <div id="productsTab" class="tab-content active">
                <h2>قائمة المنتجات</h2>
                <div id="productsAlert" class="alert" style="display: none;"></div>
                <div id="productsLoading" class="loading">
                    <div class="spinner"></div>
                    <span>جاري تحميل المنتجات...</span>
                </div>
                <div id="productsTable" style="display: none;">
                    <table>
                        <thead>
                            <tr>
                                <th>الصورة</th>
                                <th>الاسم</th>
                                <th>العلامة التجارية</th>
                                <th>الفئة</th>
                                <th>السعر</th>
                                <th>المخزون</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                            <!-- سيتم ملء هذا الجزء بالبيانات من Firestore -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- قسم إضافة منتج جديد -->
            <div id="addProductTab" class="tab-content">
                <h2>إضافة منتج جديد</h2>
                <div id="addProductAlert" class="alert" style="display: none;"></div>
                <form id="addProductForm">
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="productName">اسم المنتج</label>
                                <input type="text" id="productName" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="productBrand">العلامة التجارية</label>
                                <input type="text" id="productBrand" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="productCategory">الفئة</label>
                                <select id="productCategory" required>
                                    <option value="">اختر الفئة</option>
                                    <option value="laptop">لابتوب</option>
                                    <option value="desktop">كمبيوتر مكتبي</option>
                                    <option value="tablet">تابلت</option>
                                    <option value="phone">هاتف ذكي</option>
                                    <option value="accessory">إكسسوارات</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="productType">النوع</label>
                                <input type="text" id="productType" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="productPrice">السعر (بالدينار العراقي)</label>
                                <input type="number" id="productPrice" required>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="productOriginalPrice">السعر الأصلي (اختياري)</label>
                                <input type="number" id="productOriginalPrice">
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="productDiscount">نسبة الخصم (اختياري)</label>
                                <input type="number" id="productDiscount" step="0.1" min="0" max="100">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="productRating">التقييم (0-5)</label>
                                <input type="number" id="productRating" step="0.1" min="0" max="5" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="productBadge">شارة المنتج (اختياري)</label>
                                <input type="text" id="productBadge">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="productInStock">متوفر في المخزون</label>
                                <select id="productInStock" required>
                                    <option value="true">نعم</option>
                                    <option value="false">لا</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="productDescription">وصف المنتج</label>
                        <textarea id="productDescription" rows="4" required></textarea>
                    </div>

                    <div class="form-group">
                        <label>مميزات المنتج</label>
                        <div id="featuresContainer" class="features-container">
                            <div class="feature-item">
                                <input type="text" class="feature-input" placeholder="أدخل ميزة المنتج">
                                <button type="button" class="remove-feature-btn"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                        <button type="button" id="addFeatureBtn" class="add-feature-btn">
                            <i class="fas fa-plus"></i> إضافة ميزة
                        </button>
                    </div>

                    <div class="form-group">
                        <label>صور المنتج (روابط URL)</label>
                        <div id="imagesContainer" class="images-container">
                            <div class="image-item">
                                <input type="url" class="image-input" placeholder="أدخل رابط الصورة">
                                <button type="button" class="remove-feature-btn"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                        <button type="button" id="addImageBtn" class="add-feature-btn">
                            <i class="fas fa-plus"></i> إضافة صورة
                        </button>
                    </div>

                    <button type="submit" class="btn">إضافة المنتج</button>
                </form>
            </div>
        </div>
    </div>

    <!-- نافذة تعديل المنتج -->
    <div id="editProductModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="closeEditModal">&times;</span>
            <h2>تعديل المنتج</h2>
            <div id="editProductAlert" class="alert" style="display: none;"></div>
            <form id="editProductForm">
                <input type="hidden" id="editProductId">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="editProductName">اسم المنتج</label>
                            <input type="text" id="editProductName" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="editProductBrand">العلامة التجارية</label>
                            <input type="text" id="editProductBrand" required>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="editProductCategory">الفئة</label>
                            <select id="editProductCategory" required>
                                <option value="">اختر الفئة</option>
                                <option value="laptop">لابتوب</option>
                                <option value="desktop">كمبيوتر مكتبي</option>
                                <option value="tablet">تابلت</option>
                                <option value="phone">هاتف ذكي</option>
                                <option value="accessory">إكسسوارات</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="editProductType">النوع</label>
                            <input type="text" id="editProductType" required>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="editProductPrice">السعر (بالدينار العراقي)</label>
                            <input type="number" id="editProductPrice" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="editProductOriginalPrice">السعر الأصلي (اختياري)</label>
                            <input type="number" id="editProductOriginalPrice">
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="editProductDiscount">نسبة الخصم (اختياري)</label>
                            <input type="number" id="editProductDiscount" step="0.1" min="0" max="100">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="editProductRating">التقييم (0-5)</label>
                            <input type="number" id="editProductRating" step="0.1" min="0" max="5" required>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="editProductBadge">شارة المنتج (اختياري)</label>
                            <input type="text" id="editProductBadge">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="editProductInStock">متوفر في المخزون</label>
                            <select id="editProductInStock" required>
                                <option value="true">نعم</option>
                                <option value="false">لا</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="editProductDescription">وصف المنتج</label>
                    <textarea id="editProductDescription" rows="4" required></textarea>
                </div>

                <div class="form-group">
                    <label>مميزات المنتج</label>
                    <div id="editFeaturesContainer" class="features-container">
                        <!-- سيتم ملء هذا الجزء ديناميًا -->
                    </div>
                    <button type="button" id="editAddFeatureBtn" class="add-feature-btn">
                        <i class="fas fa-plus"></i> إضافة ميزة
                    </button>
                </div>

                <div class="form-group">
                    <label>صور المنتج (روابط URL)</label>
                    <div id="editImagesContainer" class="images-container">
                        <!-- سيتم ملء هذا الجزء ديناميًا -->
                    </div>
                    <button type="button" id="editAddImageBtn" class="add-feature-btn">
                        <i class="fas fa-plus"></i> إضافة صورة
                    </button>
                </div>

                <button type="submit" class="btn">حفظ التغييرات</button>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // استيراد المكتبات اللازمة من Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, addDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        
        // التأكد من عرض التبويبات بشكل صحيح
        document.addEventListener('DOMContentLoaded', function() {
            // التأكد من أن تبويب إضافة المنتج يعمل بشكل صحيح
            const addProductTab = document.querySelector('.tab[data-tab="add-product"]');
            const addProductTabContent = document.getElementById('addProductTab');
            
            if (addProductTab && addProductTabContent) {
                addProductTab.addEventListener('click', function() {
                    // إظهار تبويب إضافة المنتج
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    addProductTabContent.classList.add('active');
                    
                    // تحديث حالة التبويب النشط
                    document.querySelectorAll('.tab').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    addProductTab.classList.add('active');
                });
            }
        });

        // تكوين Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAI7J5rkkR3nMPdLlfV_UoeIbrAs4yMyRQ",
            authDomain: "cosmic-lens-store.firebaseapp.com",
            projectId: "cosmic-lens-store",
            storageBucket: "cosmic-lens-store.firebasestorage.app",
            messagingSenderId: "918317756201",
            appId: "1:918317756201:web:2bd7192d8114d2057c5138",
            measurementId: "G-132YF27YK7"
        };

        // تهيئة Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // عناصر واجهة المستخدم
        const loginScreen = document.getElementById('loginScreen');
        const adminPanel = document.getElementById('adminPanel');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginAlert = document.getElementById('loginAlert');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const productsTableBody = document.getElementById('productsTableBody');
        const productsLoading = document.getElementById('productsLoading');
        const productsTable = document.getElementById('productsTable');
        const productsAlert = document.getElementById('productsAlert');
        const addProductForm = document.getElementById('addProductForm');
        const addProductAlert = document.getElementById('addProductAlert');
        const editProductModal = document.getElementById('editProductModal');
        const closeEditModal = document.getElementById('closeEditModal');
        const editProductForm = document.getElementById('editProductForm');
        const editProductAlert = document.getElementById('editProductAlert');

        // التحقق من حالة تسجيل الدخول
        function checkLoginStatus() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // المستخدم مسجل دخوله
                    loginScreen.style.display = 'none';
                    adminPanel.style.display = 'block';
                    logoutBtn.style.display = 'block';
                    loadProducts();
                } else {
                    // المستخدم غير مسجل دخوله
                    loginScreen.style.display = 'block';
                    adminPanel.style.display = 'none';
                    logoutBtn.style.display = 'none';
                }
            });
        }

        // تسجيل الدخول
        loginBtn.addEventListener('click', () => {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            loginAlert.style.display = 'none';
            
            if (!email || !password) {
                loginAlert.textContent = 'يرجى إدخال البريد الإلكتروني وكلمة المرور';
                loginAlert.style.display = 'block';
                return;
            }
            
            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    // تم تسجيل الدخول بنجاح
                    const user = userCredential.user;
                    console.log('تم تسجيل الدخول بنجاح:', user.email);
                })
                .catch((error) => {
                    // حدث خطأ أثناء تسجيل الدخول
                    console.error('خطأ في تسجيل الدخول:', error);
                    let errorMessage = 'فشل تسجيل الدخول. يرجى التحقق من البريد الإلكتروني وكلمة المرور.';
                    
                    if (error.code === 'auth/invalid-email') {
                        errorMessage = 'البريد الإلكتروني غير صالح';
                    } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        errorMessage = 'البريد الإلكتروني أو كلمة المرور غير صحيحة';
                    } else if (error.code === 'auth/too-many-requests') {
                        errorMessage = 'تم تعطيل الحساب مؤقتًا بسبب محاولات تسجيل دخول متكررة. يرجى المحاولة لاحقًا';
                    }
                    
                    loginAlert.textContent = errorMessage;
                    loginAlert.style.display = 'block';
                });
        });

        // تسجيل الخروج
        logoutBtn.addEventListener('click', () => {
            signOut(auth).then(() => {
                // تم تسجيل الخروج بنجاح
                console.log('تم تسجيل الخروج بنجاح');
            }).catch((error) => {
                // حدث خطأ أثناء تسجيل الخروج
                console.error('خطأ في تسجيل الخروج:', error);
            });
        });

        // التبديل بين التبويبات
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`${tab.dataset.tab}Tab`).classList.add('active');
            });
        });

        // تنسيق السعر
        function formatPrice(price) {
            if (price === null || price === undefined) return '';
            return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // تحميل المنتجات من Firestore
        async function loadProducts() {
            productsLoading.style.display = 'flex';
            productsTable.style.display = 'none';
            productsAlert.style.display = 'none';

            try {
                const productsCollection = collection(db, 'products');
                const productsSnapshot = await getDocs(productsCollection);
                
                if (productsSnapshot.empty) {
                    productsAlert.textContent = 'لا توجد منتجات لعرضها';
                    productsAlert.className = 'alert alert-warning';
                    productsAlert.style.display = 'block';
                    productsLoading.style.display = 'none';
                    return;
                }

                let tableHTML = '';
                productsSnapshot.forEach(doc => {
                    const product = doc.data();
                    product.id = doc.id;
                    
                    tableHTML += `
                        <tr>
                            <td><img src="${product.images?.[0] || ''}" alt="${product.name}" class="product-image"></td>
                            <td>${product.name}</td>
                            <td>${product.brand}</td>
                            <td>${getCategoryName(product.category)}</td>
                            <td>${formatPrice(product.price)} د.ع</td>
                            <td>${product.inStock ? 'متوفر' : 'غير متوفر'}</td>
                            <td class="actions">
                                <button class="btn btn-warning btn-sm edit-product" data-id="${product.id}">تعديل</button>
                                <button class="btn btn-danger btn-sm delete-product" data-id="${product.id}">حذف</button>
                            </td>
                        </tr>
                    `;
                });

                productsTableBody.innerHTML = tableHTML;
                productsTable.style.display = 'block';
                
                // إضافة مستمعي الأحداث لأزرار التعديل والحذف
                document.querySelectorAll('.edit-product').forEach(button => {
                    button.addEventListener('click', () => editProduct(button.dataset.id));
                });
                
                document.querySelectorAll('.delete-product').forEach(button => {
                    button.addEventListener('click', () => deleteProduct(button.dataset.id));
                });

            } catch (error) {
                console.error('Error loading products:', error);
                productsAlert.textContent = 'حدث خطأ أثناء تحميل المنتجات';
                productsAlert.className = 'alert alert-danger';
                productsAlert.style.display = 'block';
            } finally {
                productsLoading.style.display = 'none';
            }
        }

        // الحصول على اسم الفئة بالعربية
        function getCategoryName(category) {
            const categories = {
                'laptop': 'لابتوب',
                'desktop': 'كمبيوتر مكتبي',
                'tablet': 'تابلت',
                'phone': 'هاتف ذكي',
                'accessory': 'إكسسوارات'
            };
            return categories[category] || category;
        }

        // إضافة ميزة جديدة
        document.getElementById('addFeatureBtn').addEventListener('click', () => {
            addFeatureField('featuresContainer');
        });

        // إضافة صورة جديدة
        document.getElementById('addImageBtn').addEventListener('click', () => {
            addImageField('imagesContainer');
        });

        // إضافة ميزة جديدة في نموذج التعديل
        document.getElementById('editAddFeatureBtn').addEventListener('click', () => {
            addFeatureField('editFeaturesContainer');
        });

        // إضافة صورة جديدة في نموذج التعديل
        document.getElementById('editAddImageBtn').addEventListener('click', () => {
            addImageField('editImagesContainer');
        });

        // إضافة حقل ميزة جديد
        function addFeatureField(containerId) {
            const container = document.getElementById(containerId);
            const featureItem = document.createElement('div');
            featureItem.className = 'feature-item';
            featureItem.innerHTML = `
                <input type="text" class="feature-input" placeholder="أدخل ميزة المنتج">
                <button type="button" class="remove-feature-btn"><i class="fas fa-times"></i></button>
            `;
            container.appendChild(featureItem);
            
            featureItem.querySelector('.remove-feature-btn').addEventListener('click', function() {
                container.removeChild(featureItem);
            });
        }

        // إضافة حقل صورة جديد
        function addImageField(containerId) {
            const container = document.getElementById(containerId);
            const imageItem = document.createElement('div');
            imageItem.className = 'image-item';
            imageItem.innerHTML = `
                <input type="url" class="image-input" placeholder="أدخل رابط الصورة">
                <button type="button" class="remove-feature-btn"><i class="fas fa-times"></i></button>
            `;
            container.appendChild(imageItem);
            
            imageItem.querySelector('.remove-feature-btn').addEventListener('click', function() {
                container.removeChild(imageItem);
            });
        }

        // إضافة مستمعي الأحداث لأزرار الحذف الأولية
        document.querySelectorAll('.remove-feature-btn').forEach(button => {
            button.addEventListener('click', function() {
                this.parentElement.remove();
            });
        });

        // إضافة منتج جديد
        addProductForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const productData = {
                name: document.getElementById('productName').value.trim(),
                brand: document.getElementById('productBrand').value.trim(),
                category: document.getElementById('productCategory').value,
                type: document.getElementById('productType').value.trim(),
                price: parseInt(document.getElementById('productPrice').value),
                originalPrice: document.getElementById('productOriginalPrice').value ? parseInt(document.getElementById('productOriginalPrice').value) : null,
                discount: document.getElementById('productDiscount').value ? parseFloat(document.getElementById('productDiscount').value) : null,
                description: document.getElementById('productDescription').value.trim(),
                features: Array.from(document.querySelectorAll('#featuresContainer .feature-input')).map(input => input.value.trim()).filter(value => value),
                images: Array.from(document.querySelectorAll('#imagesContainer .image-input')).map(input => input.value.trim()).filter(value => value),
                inStock: document.getElementById('productInStock').value === 'true',
                badge: document.getElementById('productBadge').value.trim() || null,
                rating: parseFloat(document.getElementById('productRating').value),
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp()
            };
            
            try {
                addProductAlert.style.display = 'none';
                
                // إضافة المنتج إلى Firestore
                const docRef = await addDoc(collection(db, 'products'), productData);
                
                // عرض رسالة نجاح
                addProductAlert.textContent = 'تم إضافة المنتج بنجاح';
                addProductAlert.className = 'alert alert-success';
                addProductAlert.style.display = 'block';
                
                // إعادة تعيين النموذج
                addProductForm.reset();
                document.getElementById('featuresContainer').innerHTML = `
                    <div class="feature-item">
                        <input type="text" class="feature-input" placeholder="أدخل ميزة المنتج">
                        <button type="button" class="remove-feature-btn"><i class="fas fa-times"></i></button>
                    </div>
                `;
                document.getElementById('imagesContainer').innerHTML = `
                    <div class="image-item">
                        <input type="url" class="image-input" placeholder="أدخل رابط الصورة">
                        <button type="button" class="remove-feature-btn"><i class="fas fa-times"></i></button>
                    </div>
                `;
                
                // إضافة مستمعي الأحداث لأزرار الحذف الجديدة
                document.querySelectorAll('.remove-feature-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        this.parentElement.remove();
                    });
                });
                
                // إعادة تحميل المنتجات
                loadProducts();
                
                // التبديل إلى تبويب المنتجات
                tabs[0].click();
                
            } catch (error) {
                console.error('Error adding product:', error);
                addProductAlert.textContent = 'حدث خطأ أثناء إضافة المنتج';
                addProductAlert.className = 'alert alert-danger';
                addProductAlert.style.display = 'block';
            }
        });

        // تعديل منتج
        async function editProduct(productId) {
            try {
                editProductAlert.style.display = 'none';
                
                // الحصول على بيانات المنتج
                const productDoc = await getDoc(doc(db, 'products', productId));
                if (!productDoc.exists()) {
                    throw new Error('المنتج غير موجود');
                }
                
                const product = productDoc.data();
                product.id = productDoc.id;
                
                // ملء نموذج التعديل بالبيانات
                document.getElementById('editProductId').value = product.id;
                document.getElementById('editProductName').value = product.name || '';
                document.getElementById('editProductBrand').value = product.brand || '';
                document.getElementById('editProductCategory').value = product.category || '';
                document.getElementById('editProductType').value = product.type || '';
                document.getElementById('editProductPrice').value = product.price || '';
                document.getElementById('editProductOriginalPrice').value = product.originalPrice || '';
                document.getElementById('editProductDiscount').value = product.discount || '';
                document.getElementById('editProductDescription').value = product.description || '';
                document.getElementById('editProductInStock').value = product.inStock ? 'true' : 'false';
                document.getElementById('editProductBadge').value = product.badge || '';
                document.getElementById('editProductRating').value = product.rating || '0';
                
                // ملء مميزات المنتج
                const editFeaturesContainer = document.getElementById('editFeaturesContainer');
                editFeaturesContainer.innerHTML = '';
                
                if (product.features && product.features.length > 0) {
                    product.features.forEach(feature => {
                        const featureItem = document.createElement('div');
                        featureItem.className = 'feature-item';
                        featureItem.innerHTML = `
                            <input type="text" class="feature-input" placeholder="أدخل ميزة المنتج" value="${feature}">
                            <button type="button" class="remove-feature-btn"><i class="fas fa-times"></i></button>
                        `;
                        editFeaturesContainer.appendChild(featureItem);
                        
                        featureItem.querySelector('.remove-feature-btn').addEventListener('click', function() {
                            editFeaturesContainer.removeChild(featureItem);
                        });
                    });
                } else {
                    addFeatureField('editFeaturesContainer');
                }
                
                // ملء صور المنتج
                const editImagesContainer = document.getElementById('editImagesContainer');
                editImagesContainer.innerHTML = '';
                
                if (product.images && product.images.length > 0) {
                    product.images.forEach(image => {
                        const imageItem = document.createElement('div');
                        imageItem.className = 'image-item';
                        imageItem.innerHTML = `
                            <input type="url" class="image-input" placeholder="أدخل رابط الصورة" value="${image}">
                            <button type="button" class="remove-feature-btn"><i class="fas fa-times"></i></button>
                        `;
                        editImagesContainer.appendChild(imageItem);
                        
                        imageItem.querySelector('.remove-feature-btn').addEventListener('click', function() {
                            editImagesContainer.removeChild(imageItem);
                        });
                    });
                } else {
                    addImageField('editImagesContainer');
                }
                
                // عرض نافذة التعديل
                editProductModal.style.display = 'block';
                
            } catch (error) {
                console.error('Error loading product for edit:', error);
                productsAlert.textContent = 'حدث خطأ أثناء تحميل بيانات المنتج';
                productsAlert.className = 'alert alert-danger';
                productsAlert.style.display = 'block';
            }
        }

        // غلاق نافذة التعديل
        closeEditModal.addEventListener('click', () => {
            editProductModal.style.display = 'none';
        });

        // النقر خارج نافذة التعديل لغلاقها
        window.addEventListener('click', (e) => {
            if (e.target === editProductModal) {
                editProductModal.style.display = 'none';
            }
        });

        // حفظ تعديلات المنتج
        editProductForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const productId = document.getElementById('editProductId').value;
            
            const productData = {
                name: document.getElementById('editProductName').value.trim(),
                brand: document.getElementById('editProductBrand').value.trim(),
                category: document.getElementById('editProductCategory').value,
                type: document.getElementById('editProductType').value.trim(),
                price: parseInt(document.getElementById('editProductPrice').value),
                originalPrice: document.getElementById('editProductOriginalPrice').value ? parseInt(document.getElementById('editProductOriginalPrice').value) : null,
                discount: document.getElementById('editProductDiscount').value ? parseFloat(document.getElementById('editProductDiscount').value) : null,
                description: document.getElementById('editProductDescription').value.trim(),
                features: Array.from(document.querySelectorAll('#editFeaturesContainer .feature-input')).map(input => input.value.trim()).filter(value => value),
                images: Array.from(document.querySelectorAll('#editImagesContainer .image-input')).map(input => input.value.trim()).filter(value => value),
                inStock: document.getElementById('editProductInStock').value === 'true',
                badge: document.getElementById('editProductBadge').value.trim() || null,
                rating: parseFloat(document.getElementById('editProductRating').value),
                updatedAt: serverTimestamp()
            };
            
            try {
                editProductAlert.style.display = 'none';
                
                // تحديث المنتج في Firestore
                await updateDoc(doc(db, 'products', productId), productData);
                
                // عرض رسالة نجاح
                editProductAlert.textContent = 'تم تحديث المنتج بنجاح';
                editProductAlert.className = 'alert alert-success';
                editProductAlert.style.display = 'block';
                
                // إعادة تحميل المنتجات
                loadProducts();
                
                // إغلاق نافذة التعديل بعد ثانيتين
                setTimeout(() => {
                    editProductModal.style.display = 'none';
                }, 2000);
                
            } catch (error) {
                console.error('Error updating product:', error);
                editProductAlert.textContent = 'حدث خطأ أثناء تحديث المنتج';
                editProductAlert.className = 'alert alert-danger';
                editProductAlert.style.display = 'block';
            }
        });

        // حذف منتج
        async function deleteProduct(productId) {
            if (!confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
                return;
            }
            
            try {
                productsAlert.style.display = 'none';
                
                // حذف المنتج من Firestore
                await deleteDoc(doc(db, 'products', productId));
                
                // عرض رسالة نجاح
                productsAlert.textContent = 'تم حذف المنتج بنجاح';
                productsAlert.className = 'alert alert-success';
                productsAlert.style.display = 'block';
                
                // إعادة تحميل المنتجات
                loadProducts();
                
            } catch (error) {
                console.error('Error deleting product:', error);
                productsAlert.textContent = 'حدث خطأ أثناء حذف المنتج';
                productsAlert.className = 'alert alert-danger';
                productsAlert.style.display = 'block';
            }
        }

        // التحقق من حالة تسجيل الدخول عند تحميل الصفحة
        checkLoginStatus();
    </script>
</body>
</html>
